<div class="track-container">
  <!-- Breadcrumb Navigation -->
  <app-breadcrumb [breadcrumbs]="breadcrumbs"></app-breadcrumb>

  <!-- Track Header -->
  <div class="track-header" *ngIf="track && !loading">
    <div class="container">
      <div class="track-info">
        <div class="track-image">
          <img
            [src]="getImageUrl(track.album.images)"
            [alt]="track.album.name"
          />
          <div class="play-overlay" (click)="playTrack()">
            <i class="fas fa-play"></i>
          </div>
        </div>
        <div class="track-details">
          <h1 class="track-name">{{ track.name }}</h1>
          <p class="track-artist">
            <a
              [routerLink]="['/artist', artist.id]"
              *ngFor="let artist of track.artists; let last = last"
            >
              {{ artist.name }}<span *ngIf="!last">, </span>
            </a>
          </p>
          <p class="track-album">
            <a [routerLink]="['/album', track.album.id]">{{
              track.album.name
            }}</a>
          </p>
          <div class="track-meta">
            <div class="meta-item">
              <i class="fas fa-clock"></i>
              <span>{{ formatDuration(track.duration_ms) }}</span>
            </div>
            <div class="meta-item">
              <i class="fas fa-fire"></i>
              <span>{{ track.popularity }}% popular</span>
            </div>
            <div class="meta-item">
              <i class="fas fa-calendar"></i>
              <span>{{ track.album.release_date | date : "yyyy" }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State for Track Header -->
  <div class="track-header loading" *ngIf="loading">
    <div class="container">
      <div class="track-info">
        <div class="track-image placeholder-glow">
          <span
            class="placeholder"
            style="width: 200px; height: 200px; border-radius: 15px"
          ></span>
        </div>
        <div class="track-details">
          <div class="placeholder-glow">
            <span
              class="placeholder col-8"
              style="height: 2rem; margin-bottom: 1rem"
            ></span>
            <span
              class="placeholder col-6"
              style="height: 1.5rem; margin-bottom: 1rem"
            ></span>
            <span
              class="placeholder col-4"
              style="height: 1.2rem; margin-bottom: 1.5rem"
            ></span>
            <span class="placeholder col-3" style="height: 1rem"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Audio Player Section -->
    <section class="section" *ngIf="track && !loading">
      <div class="section-header">
        <h2 class="section-title"><i class="fas fa-music"></i> Preview</h2>
      </div>

      <div class="audio-player-section">
        <div class="audio-player-card">
          <div class="player-info">
            <div class="player-image">
              <img
                [src]="getImageUrl(track.album.images)"
                [alt]="track.album.name"
              />
            </div>
            <div class="player-details">
              <h4>{{ track.name }}</h4>
              <p>{{ getArtistNames(track.artists) }}</p>
            </div>
          </div>

          <div class="player-controls">
            <button
              class="play-btn"
              (click)="playTrack()"
              [disabled]="!hasPreviewUrl()"
              [class.disabled]="!hasPreviewUrl()"
            >
              <i class="fas fa-play" *ngIf="!isPlaying"></i>
              <i class="fas fa-pause" *ngIf="isPlaying"></i>
            </button>
          </div>

          <!-- Enhanced Preview Status -->
          <div class="preview-status-section">
            <div class="preview-available" *ngIf="hasPreviewUrl()">
              <div class="status-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="status-content">
                <span class="status-title">Preview Available</span>
                <span class="status-subtitle"
                  >30-second sample ready to play</span
                >
              </div>
            </div>

            <div class="preview-unavailable" *ngIf="!hasPreviewUrl()">
              <div class="status-icon">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <div class="status-content">
                <span class="status-title">No Preview Available</span>
                <span class="status-subtitle"
                  >This track doesn't have a preview sample</span
                >
              </div>
              <div class="status-actions">
                <button
                  class="spotify-link-btn"
                  (click)="openInSpotify()"
                  *ngIf="track?.external_urls?.spotify"
                  title="Open in Spotify"
                >
                  <i class="fab fa-spotify"></i>
                  Open in Spotify
                </button>
                <span
                  class="no-spotify-url"
                  *ngIf="!track?.external_urls?.spotify"
                  title="No Spotify URL available"
                >
                  <i class="fas fa-info-circle"></i>
                  No Spotify link available
                </span>
              </div>
            </div>
          </div>

          <!-- Audio Player -->
          <div class="audio-container" *ngIf="hasPreviewUrl()">
            <audio
              controls
              class="audio-player"
              #audioPlayer
              (loadedmetadata)="onAudioLoaded()"
              (timeupdate)="onTimeUpdate()"
              (ended)="onAudioEnded()"
            >
              <source [src]="track.preview_url" type="audio/mpeg" />
              Your browser does not support the audio element.
            </audio>
          </div>

          <!-- Enhanced Preview Actions -->
          <div class="preview-actions" *ngIf="!hasPreviewUrl()">
            <div class="action-group">
              <button
                class="action-btn primary-btn"
                (click)="openInSpotify()"
                *ngIf="track?.external_urls?.spotify"
              >
                <i class="fab fa-spotify"></i>
                <span>Listen on Spotify</span>
              </button>

              <button
                class="action-btn secondary-btn"
                (click)="tryFindPreview()"
                [disabled]="isSearchingPreview"
              >
                <i class="fas fa-search" *ngIf="!isSearchingPreview"></i>
                <i
                  class="fas fa-spinner fa-spin"
                  *ngIf="isSearchingPreview"
                ></i>
                <span>{{
                  isSearchingPreview ? "Searching..." : "Find Alternative"
                }}</span>
              </button>
            </div>

            <div class="action-info">
              <i class="fas fa-info-circle"></i>
              <span>Preview finding via backend API</span>
              <button
                class="action-btn test-btn"
                (click)="testBackend()"
                title="Test backend connectivity"
              >
                <i class="fas fa-vial"></i>
                <span>Test Backend</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Track Details Section -->
    <section class="section" *ngIf="track && !loading">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-info-circle"></i> Track Information
        </h2>
      </div>

      <div class="track-details-grid">
        <div class="detail-card">
          <div class="detail-icon">
            <i class="fas fa-music"></i>
          </div>
          <div class="detail-content">
            <h5>Track Name</h5>
            <p>{{ track.name }}</p>
          </div>
        </div>

        <div class="detail-card">
          <div class="detail-icon">
            <i class="fas fa-user"></i>
          </div>
          <div class="detail-content">
            <h5>Artists</h5>
            <p>{{ getArtistNames(track.artists) }}</p>
          </div>
        </div>

        <div class="detail-card">
          <div class="detail-icon">
            <i class="fas fa-compact-disc"></i>
          </div>
          <div class="detail-content">
            <h5>Album</h5>
            <p>
              <a [routerLink]="['/album', track.album.id]">{{
                track.album.name
              }}</a>
            </p>
          </div>
        </div>

        <div class="detail-card">
          <div class="detail-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="detail-content">
            <h5>Duration</h5>
            <p>{{ formatDuration(track.duration_ms) }}</p>
          </div>
        </div>

        <div class="detail-card">
          <div class="detail-icon">
            <i class="fas fa-fire"></i>
          </div>
          <div class="detail-content">
            <h5>Popularity</h5>
            <p>{{ track.popularity }}%</p>
          </div>
        </div>

        <div class="detail-card">
          <div class="detail-icon">
            <i class="fas fa-calendar"></i>
          </div>
          <div class="detail-content">
            <h5>Release Date</h5>
            <p>{{ track.album.release_date | date : "fullDate" }}</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Album Information Section -->
    <section class="section" *ngIf="track && !loading">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-compact-disc"></i> From Album
        </h2>
      </div>

      <div class="album-card">
        <div class="album-image">
          <img
            [src]="getImageUrl(track.album.images)"
            [alt]="track.album.name"
          />
        </div>
        <div class="album-info">
          <h3 class="album-name">
            <a [routerLink]="['/album', track.album.id]">{{
              track.album.name
            }}</a>
          </h3>
          <p class="album-artist">{{ getArtistNames(track.album.artists) }}</p>
          <p class="album-year">
            {{ track.album.release_date | date : "yyyy" }}
          </p>
          <p class="album-type">{{ track.album.album_type | titlecase }}</p>
          <div class="album-actions">
            <a
              [routerLink]="['/album', track.album.id]"
              class="btn btn-primary"
            >
              <i class="fas fa-list"></i> View Album
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Loading State -->
    <div class="loading-container" *ngIf="loading">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p>Loading track information...</p>
    </div>

    <!-- Error State -->
    <div class="error-container" *ngIf="!loading && !track">
      <div class="error-content">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>Track Not Found</h3>
        <p>The track you're looking for could not be found.</p>
        <a routerLink="/search" class="btn btn-primary">
          <i class="fas fa-search"></i> Search for Music
        </a>
      </div>
    </div>
  </div>
</div>
